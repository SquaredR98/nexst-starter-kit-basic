version: '3.8'

services:
  # ERP Application
  erp-app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      # Database
      - DATABASE_URL=postgresql://erp_user:erp_password@postgres:5432/erp_system
      
      # NextAuth
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      
      # Application
      - APP_ENV=production
      - APP_NAME=ERP System
      - APP_URL=http://localhost:3000
      
      # Deployment Type (cloud/onpremise/hybrid)
      - DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-cloud}
      
      # License (for on-premise)
      - LICENSE_PUBLIC_KEY=${LICENSE_PUBLIC_KEY}
      - LICENSE_DATA=${LICENSE_DATA}
      
      # Storage
      - STORAGE_TYPE=${STORAGE_TYPE:-local}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      
      # Payment Gateway
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET}
      
      # Redis
      - REDIS_URL=redis://redis:6379
      
      # Email
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      
      # Monitoring
      - SENTRY_DSN=${SENTRY_DSN}
      - GOOGLE_ANALYTICS_ID=${GOOGLE_ANALYTICS_ID}
      
      # Feature Flags
      - ENABLE_AUDIT_LOGGING=true
      - ENABLE_SUBSCRIPTION_CHECKS=${ENABLE_SUBSCRIPTION_CHECKS:-true}
      - ENABLE_MULTI_TENANCY=true
    
    depends_on:
      - postgres
      - redis
    
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./license.json:/app/license.json:ro  # For on-premise license file
    
    restart: unless-stopped
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.erp.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.services.erp.loadbalancer.server.port=3000"

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=erp_system
      - POSTGRES_USER=erp_user
      - POSTGRES_PASSWORD=erp_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    restart: unless-stopped
    ports:
      - "5432:5432"  # Expose for external access if needed

  # Redis for Sessions & Cache
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped
    ports:
      - "6379:6379"  # Expose for external access if needed

  # Reverse Proxy (Optional)
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/certs
    restart: unless-stopped
    profiles:
      - proxy

  # Backup Service
  backup:
    image: postgres:15-alpine
    environment:
      - PGPASSWORD=erp_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    command: |
      sh -c "
        while true; do
          sleep 86400  # 24 hours
          pg_dump -h postgres -U erp_user -d erp_system > /backups/backup_$$(date +%Y%m%d_%H%M%S).sql
          find /backups -name '*.sql' -mtime +7 -delete  # Keep 7 days of backups
        done
      "
    depends_on:
      - postgres
    restart: unless-stopped
    profiles:
      - backup

volumes:
  postgres_data:
  redis_data:

networks:
  default:
    name: erp-network 