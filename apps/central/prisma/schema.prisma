// Central App Schema - Platform Management + Business Operations
// Handles platform management, tenant registry, and central organization business operations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PLATFORM MANAGEMENT (SaaS Provider Features)
// ============================================================================

model PlatformTenant {
  id           String  @id @default(cuid())
  companyName  String
  slug         String  @unique
  corporateGST String? // Main company GST number
  industry     String?
  contactEmail String
  contactPhone String?

  // Database Configuration (Encrypted)
  databaseConfig Json // Encrypted tenant database credentials
  databaseUrl    String? // Optional: if using connection string
  databaseStatus DatabaseStatus @default(CONNECTING)

  // Business Information
  country  String @default("IN")
  currency String @default("INR")
  timezone String @default("Asia/Kolkata")

  // Platform Status
  isActive          Boolean          @default(true)
  isPlatformManaged Boolean          @default(false) // true for SaaS, false for on-premise
  onboardingStatus  OnboardingStatus @default(PENDING)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastConnectedAt DateTime?

  // Relations
  subscription  PlatformSubscription?
  stateBranches PlatformStateBranch[]
  auditLogs     PlatformAuditLog[]
  apiKeys       PlatformApiKey[]

  @@map("platform_tenants")
}

model PlatformStateBranch {
  id           String  @id @default(cuid())
  tenantId     String
  stateName    String // "Maharashtra", "Karnataka"
  stateCode    String // "MH", "KA"
  gstNumber    String // State-specific GST registration
  branchName   String // "Mumbai Office", "Bangalore Branch"
  address      Json // Complete address with pin code
  isHeadOffice Boolean @default(false)
  isActive     Boolean @default(true)

  // GST Configuration
  gstConfiguration Json // State-specific GST settings

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant PlatformTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, stateCode])
  @@map("platform_state_branches")
}

// ============================================================================
// SUBSCRIPTION & BILLING MANAGEMENT
// ============================================================================

model SubscriptionPlan {
  id               String       @id @default(cuid())
  name             String
  description      String?
  billingCycle     BillingCycle
  pricePerMonth    Float
  pricePerYear     Float?
  maxUsers         Int          @default(10)
  maxStateBranches Int          @default(1)
  features         Json // Available features
  isActive         Boolean      @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions PlatformSubscription[]

  @@map("subscription_plans")
}

model PlatformSubscription {
  id       String             @id @default(cuid())
  tenantId String             @unique
  planId   String
  status   SubscriptionStatus @default(TRIAL)

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  billingCycle       BillingCycle
  amount             Float
  currency           String       @default("INR")

  // Usage Tracking
  usersCount         Int @default(0)
  stateBranchesCount Int @default(0)

  // Payment
  lastPaymentDate DateTime?
  nextPaymentDate DateTime?
  paymentMethod   String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant PlatformTenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("platform_subscriptions")
}

// ============================================================================
// GST REFERENCE DATA (CENTRALIZED)
// ============================================================================

model Country {
  id       String   @id @default(cuid())
  name     String
  code     String   @unique // "IN", "US", "UK"
  currency String // "INR", "USD", "GBP"
  timezone String[]
  isActive Boolean  @default(true)

  // Relations
  states State[]

  @@map("countries")
}

model State {
  id           String  @id @default(cuid())
  countryId    String
  name         String // "Maharashtra", "Karnataka"
  code         String // "MH", "KA"
  gstStateCode String // "27", "29" (for GST purposes)
  isActive     Boolean @default(true)

  // Relations
  country  Country   @relation(fields: [countryId], references: [id])
  cities   City[]
  gstRates GSTRate[]

  @@unique([countryId, code])
  @@map("states")
}

model City {
  id          String   @id @default(cuid())
  stateId     String
  name        String
  postalCodes String[] // Array of postal codes for this city
  isActive    Boolean  @default(true)

  // Relations
  state State @relation(fields: [stateId], references: [id])

  @@map("cities")
}

model GSTRate {
  id          String  @id @default(cuid())
  stateId     String? // NULL for national rates
  category    String // "goods", "services", "luxury", etc.
  hsn         String? // HSN/SAC code
  description String

  // Tax Rates
  cgstRate Float @default(0)
  sgstRate Float @default(0)
  igstRate Float @default(0)
  cessRate Float @default(0)

  // Validity
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  state State? @relation(fields: [stateId], references: [id])

  @@map("gst_rates")
}

model GSTComplianceSchedule {
  id          String              @id @default(cuid())
  returnType  GSTReturnType
  description String
  frequency   ComplianceFrequency
  dueDays     Int // Days after month/quarter end
  penaltyRate Float               @default(0)
  isActive    Boolean             @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gst_compliance_schedules")
}

// ============================================================================
// PLATFORM API MANAGEMENT
// ============================================================================

model PlatformApiKey {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  keyHash     String    @unique // Hashed API key
  permissions Json // API permissions
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant PlatformTenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("platform_api_keys")
}

// ============================================================================
// CROSS-TENANT AUDIT LOGGING
// ============================================================================

model PlatformAuditLog {
  id       String  @id @default(cuid())
  tenantId String? // NULL for platform-level actions

  // Action Details
  action     String // "TENANT_CREATED", "DATABASE_CONNECTED", etc.
  entityType String // "tenant", "subscription", "user"
  entityId   String?

  // User Context
  performedBy     String? // User ID or "SYSTEM"
  performedByType String  @default("USER") // "USER", "ADMIN", "SYSTEM", "API"

  // Details
  details   Json? // Additional context
  ipAddress String?
  userAgent String?

  // Results
  success      Boolean @default(true)
  errorMessage String?

  // Timestamps
  timestamp DateTime @default(now())

  // Relations
  tenant PlatformTenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId, timestamp])
  @@index([action, timestamp])
  @@map("platform_audit_logs")
}

// ============================================================================
// PLATFORM CONFIGURATION
// ============================================================================

model PlatformConfig {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?
  isSecret    Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_config")
}

// ============================================================================
// CENTRAL ORGANIZATION BUSINESS OPERATIONS
// ============================================================================

model Organization {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  logo        String?
  website     String?
  industry    String?

  // Business Information
  panNumber String? // Company PAN
  cinNumber String? // Corporate Identification Number
  country   String  @default("IN")
  currency  String  @default("INR")
  timezone  String  @default("Asia/Kolkata")

  // Status
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         User[]
  departments   Department[]
  roles         Role[]
  permissions   Permission[]
  customers     Customer[]
  suppliers     Supplier[]
  products      Product[]
  transactions  Transaction[]
  gstReturns    GSTReturn[]
  auditLogs     AuditLog[]
  tenantThemes  TenantTheme[]

  @@map("organizations")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id             String  @id @default(cuid())
  organizationId String
  email          String  @unique
  username       String? @unique
  firstName      String
  lastName       String
  phone          String?
  avatar         String?
  passwordHash   String?

  // User Status
  emailVerified DateTime?
  phoneVerified DateTime?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?

  // Employment Details
  employeeId   String?
  designation  String?
  departmentId String?
  managerId    String?
  joinDate     DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?  @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  manager      User?        @relation("UserManager", fields: [managerId], references: [id])
  subordinates User[]       @relation("UserManager")

  // RBAC
  userRoles UserRole[]

  // Business Relations
  assignedCustomers   Customer[]    @relation("CustomerAssignments")
  createdTransactions Transaction[] @relation("TransactionCreator")

  // Audit
  auditLogs AuditLog[] @relation("AuditUser")

  // Sessions
  sessions Session[]

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Department {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  code           String
  description    String?
  parentId       String?
  managerId      String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children     Department[] @relation("DepartmentHierarchy")
  employees    User[]       @relation("DepartmentEmployees")

  @@unique([organizationId, code])
  @@map("departments")
}

// ============================================================================
// ROLE-BASED ACCESS CONTROL
// ============================================================================

model Role {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  description    String?
  level          Int      @default(1) // Role hierarchy level
  isSystemRole   Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions  RolePermission[]
  userRoles    UserRole[]

  @@unique([organizationId, name])
  @@map("roles")
}

model Permission {
  id             String           @id @default(cuid())
  organizationId String
  name           String
  description    String?
  module         ModuleType
  action         PermissionAction
  scope          PermissionScope
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  @@unique([organizationId, name])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  isActive   Boolean   @default(true)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// ============================================================================
// BUSINESS ENTITIES (For Central Organization)
// ============================================================================

model Customer {
  id             String  @id @default(cuid())
  organizationId String
  code           String
  name           String
  email          String?
  phone          String?
  website        String?

  // Address Information
  billingAddress  Json
  shippingAddress Json?

  // Business Information
  gstNumber    String?
  panNumber    String?
  customerType CustomerType @default(B2B)

  // Customer Classification
  category    String? // "Premium", "Regular", "New"
  creditLimit Float   @default(0)
  creditDays  Int     @default(30)

  // Relationship Management
  contactPerson String?
  assignedTo    String? // User ID for assigned sales rep

  // Status
  status   CustomerStatus @default(ACTIVE)
  isActive Boolean        @default(true)
  notes    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedUser User?         @relation("CustomerAssignments", fields: [assignedTo], references: [id])
  transactions Transaction[]

  // Custom fields
  customFields      Json     @default("{}") // Store custom field values

  @@unique([organizationId, code])
  @@map("customers")
}

model Supplier {
  id             String  @id @default(cuid())
  organizationId String
  code           String
  name           String
  email          String?
  phone          String?
  website        String?

  // Address Information
  address Json

  // Business Information
  gstNumber    String?
  panNumber    String?
  supplierType SupplierType @default(GOODS)

  // Payment Terms
  paymentTerms Int   @default(30) // Days
  creditLimit  Float @default(0)

  // Status
  isActive Boolean @default(true)
  notes    String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  // Custom fields
  customFields      Json     @default("{}") // Store custom field values

  @@unique([organizationId, code])
  @@map("suppliers")
}

model Product {
  id             String  @id @default(cuid())
  organizationId String
  code           String
  name           String
  description    String?

  // Product Classification
  category    String?
  subcategory String?
  brand       String?
  model       String?

  // GST Information
  hsnCode     String? // HSN/SAC code for GST
  gstCategory String  @default("goods") // "goods", "services"

  // Pricing
  basePrice     Float @default(0)
  sellingPrice  Float @default(0)
  purchasePrice Float @default(0)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactionItems TransactionItem[]

  // Custom fields
  customFields      Json     @default("{}") // Store custom field values

  @@unique([organizationId, code])
  @@map("products")
}

// ============================================================================
// TRANSACTION MANAGEMENT
// ============================================================================

model Transaction {
  id                String  @id @default(cuid())
  organizationId    String

  // Transaction Basic Info
  transactionNumber String          @unique
  transactionType   TransactionType
  transactionDate   DateTime
  dueDate           DateTime?

  // Parties
  customerId String?
  supplierId String?

  // Financial Details
  subtotal       Float @default(0)
  discountAmount Float @default(0)
  taxableAmount  Float @default(0)

  // GST Calculations
  cgstRate       Float? // Only for intrastate
  sgstRate       Float? // Only for intrastate  
  igstRate       Float? // Only for interstate
  cessRate       Float? // Additional cess
  cgstAmount     Float  @default(0)
  sgstAmount     Float  @default(0)
  igstAmount     Float  @default(0)
  cessAmount     Float  @default(0)
  totalTaxAmount Float  @default(0)
  totalAmount    Float  @default(0)

  // Payment Information
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?
  paymentDate   DateTime?

  // Status & Metadata
  status    TransactionStatus @default(DRAFT)
  notes     String?
  createdBy String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer        Customer?         @relation(fields: [customerId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  createdByUser   User              @relation("TransactionCreator", fields: [createdBy], references: [id])
  items           TransactionItem[]

  // Custom fields
  customFields      Json     @default("{}") // Store custom field values

  @@map("transactions")
  GSTReturn GSTReturn[]
}

model TransactionItem {
  id            String @id @default(cuid())
  transactionId String
  productId     String

  // Item Details
  description    String?
  quantity       Float
  unit           String  @default("PCS")
  unitPrice      Float   @default(0)
  discountRate   Float   @default(0)
  discountAmount Float   @default(0)
  lineTotal      Float   @default(0)

  // GST for this item
  hsnCode   String?
  gstRate   Float   @default(0)
  cgstRate  Float   @default(0)
  sgstRate  Float   @default(0)
  igstRate  Float   @default(0)
  taxAmount Float   @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id])

  @@map("transaction_items")
}

// ============================================================================
// GST COMPLIANCE
// ============================================================================

model GSTReturn {
  id             String @id @default(cuid())
  organizationId String

  // Return Details
  returnType   GSTReturnType
  periodMonth  Int // 1-12
  periodYear   Int
  filingStatus FilingStatus  @default(DRAFT)

  // Calculated Values
  totalSales     Float @default(0)
  totalPurchases Float @default(0)
  cgstPayable    Float @default(0)
  sgstPayable    Float @default(0)
  igstPayable    Float @default(0)
  cessPayable    Float @default(0)
  inputTaxCredit Float @default(0)
  netTaxPayable  Float @default(0)

  // Filing Information
  preparedBy     String? // User who prepared
  reviewedBy     String? // User who reviewed
  filedBy        String? // User who filed
  filedDate      DateTime?
  acknowledgment String? // Government acknowledgment number

  // Compliance
  dueDate        DateTime
  penaltyAmount  Float    @default(0)
  interestAmount Float    @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([organizationId, returnType, periodMonth, periodYear])
  @@map("gst_returns")
}

// ============================================================================
// THEME & CUSTOMIZATION
// ============================================================================

model TenantTheme {
  id                String   @id @default(cuid())
  organizationId    String
  
  // Theme configuration
  themeName         String
  themeData         Json     // Complete theme configuration
  
  // Theme metadata
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  version           String   @default("1.0.0")
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, themeName])
  @@map("tenant_themes")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id             String @id @default(cuid())
  organizationId String

  // Action Details
  action     String // "CUSTOMER_CREATED", "INVOICE_GENERATED", etc.
  entityType String // "customer", "transaction", "user"
  entityId   String?
  oldValues  Json? // Previous values
  newValues  Json? // New values

  // User Context
  userId    String?
  ipAddress String?
  userAgent String?

  // Results
  success      Boolean @default(true)
  errorMessage String?

  // Timestamps
  timestamp DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("AuditUser", fields: [userId], references: [id])

  @@index([organizationId, timestamp])
  @@index([entityType, entityId])
  @@index([userId, timestamp])
  @@map("audit_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum DatabaseStatus {
  CONNECTING
  CONNECTED
  FAILED
  MAINTENANCE
  MIGRATING
}

enum OnboardingStatus {
  PENDING
  DATABASE_SETUP
  STATE_CONFIGURATION
  USER_SETUP
  COMPLETED
  FAILED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
  CUSTOM
}

enum GSTReturnType {
  GSTR1 // Outward supplies
  GSTR3B // Summary return
  GSTR9 // Annual return
  GSTR2A // Auto-populated inward supplies
  GSTR4 // Quarterly return for composition dealers
}

enum ComplianceFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum ModuleType {
  FINANCIAL
  INVENTORY
  CRM
  HUMAN_RESOURCES
  MANUFACTURING
  PROJECT_MANAGEMENT
  ADMINISTRATION
  REPORTS
  GST_COMPLIANCE
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  EXPORT
  IMPORT
  MANAGE
}

enum PermissionScope {
  GLOBAL
  ORGANIZATION
  DEPARTMENT
  TEAM
  PERSONAL
}

enum CustomerType {
  B2B // Business to Business
  B2C // Business to Consumer
  EXPORT // Export customer
  DEALER // Authorized dealer
  DISTRIBUTOR // Distributor
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  SUSPENDED
}

enum SupplierType {
  GOODS // Goods supplier
  SERVICES // Service provider
  BOTH // Both goods and services
  CONTRACTOR // Contractor
}

enum TransactionType {
  SALE_INVOICE // Sale to customer
  PURCHASE_INVOICE // Purchase from supplier
  CREDIT_NOTE // Credit note to customer
  DEBIT_NOTE // Debit note to supplier
  QUOTATION // Sales quotation
  PURCHASE_ORDER // Purchase order
  DELIVERY_NOTE // Delivery challan
  RECEIPT_NOTE // Goods receipt
  RETURN_SALE // Sales return
  RETURN_PURCHASE // Purchase return
}

enum TransactionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  DELIVERED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  VOID
}

enum PaymentStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
  REFUNDED
}

enum FilingStatus {
  DRAFT
  PREPARED
  UNDER_REVIEW
  READY_TO_FILE
  FILED
  LATE_FILED
  REVISED
  REJECTED
} 